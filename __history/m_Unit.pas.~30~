unit m_Unit;

interface

uses
    Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
    Dialogs, StdCtrls, HtmlParser, IdHTTP, IdBaseComponent, IdComponent,
    sSkinManager, sEdit, ComCtrls, sListView, sButton, IdTCPConnection,
    IdTCPClient, Menus, Clipbrd;

type
    Tm_Form = class(TForm)
        IdHTTP: TIdHTTP;
        sSkinManager: TsSkinManager;
        sListView: TsListView;
        sEdit: TsEdit;
        sButton: TsButton;
        PopupMenu: TPopupMenu;
        N1: TMenuItem;
        N2: TMenuItem;
        procedure sButtonClick(Sender: TObject);
        procedure N1Click(Sender: TObject);
        procedure sListViewMouseDown(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    private
        { Private declarations }
    public
        { Public declarations }
    end;

var
    m_Form: Tm_Form;

implementation

{$R *.dfm}

procedure Tm_Form.N1Click(Sender: TObject);
begin
    Clipbrd.Clipboard.AsText := sListView.Selected.Caption + ' | ' + sListView.Selected.SubItems.Strings[0] + ' | ' + sListView.Selected.SubItems.Strings[1] + ' | ' + sListView.Selected.SubItems.Strings[2];
    MessageDlg('复制成功！', mtInformation, [mbyes], 0);
end;

procedure Tm_Form.sButtonClick(Sender: TObject);
var
    HTTP: TIdHTTP;
    i, j: Integer;
    doc: IHtmlElement;
    tr, td: IHtmlElementList;
    ResponseStream: TStringStream;
    ParamPost: TStringList;
begin
    ResponseStream := TStringstream.Create('', TEncoding.UTF8);
    ParamPost := TStringList.Create;
    HTTP := TIdHTTP.Create(nil);
    try
        ParamPost.Add('type=1');
        ParamPost.Add('key=' + sEdit.Text);
        HTTP.Post('http://shota.cc/tools/qun.php', ParamPost, ResponseStream);
        doc := ParserHTML(ResponseStream.DataString);
        tr := doc.SimpleCSSSelector('table tbody tr');
        if tr.Count = 0 then
            MessageDlg('社工库未收录该QQ号信息！', mtwarning, [mbOK], 0)
        else
        begin
            sListView.Items.Clear;
            for i := 0 to tr.Count - 1 do
            begin
                td := ParserHTML(tr[i].InnerHtml).SimpleCSSSelector('td');
                sListView.Items.BeginUpdate;
                for j := 0 to td.Count div 4 - 1 do
                begin
                    sListView.Items.Add.Caption := td[1].InnerText;
                    sListView.Items[sListView.Items.Count - 1].SubItems.Add(td[2].InnerText);
                    sListView.Items[sListView.Items.Count - 1].SubItems.Add(td[3].InnerText);
                    sListView.Items[sListView.Items.Count - 1].SubItems.Add(td[4].InnerText);
                    Application.ProcessMessages;
                end;
                sListView.Items.EndUpdate;
            end;
            sListView.Refresh;
        end;
    finally
        FreeAndNil(HTTP);
        ParamPost.Free;
        ResponseStream.Free;
    end;

end;

procedure Tm_Form.sListViewMouseDown(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
var
    P: TPoint;
begin
    GetCursorPos(P);
    if Button = mbRight then
        if sListView.ItemIndex <> -1 then
            PopupMenu.Popup(P.X, P.Y)
end;

end.

